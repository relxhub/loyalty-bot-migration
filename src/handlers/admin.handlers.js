// src/handlers/admin.handlers.js

import { prisma } from '../db.js';
import { getActiveCampaign } from '../services/campaign.service.js';
import { sendAdminReply, sendAlertToSuperAdmin } from '../services/notification.service.js';
import { giveReferralBonus } from '../services/customer.service.js'; // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á function ‡∏ô‡∏µ‡πâ
import { addDays } from '../utils/date.utils.js';
import { generateUniqueCode } from '../utils/crypto.utils.js'; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ function ‡∏ô‡∏µ‡πâ
import { isValidIdFormat } from '../utils/validation.utils.js'; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ function ‡∏ô‡∏µ‡πâ

// ‚≠êÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà Placeholder)
export async function handleNewCustomer(ctx, commandParts) {
    
    const newCustomerId = commandParts[1]?.toUpperCase();
    const referrerId = commandParts[2]?.toUpperCase() || null;
    const adminUser = ctx.from.username || ctx.from.first_name;
    const chatId = ctx.chat.id;

    // --- 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Validations) ---
    if (!newCustomerId || commandParts.length > 3) {
        return ctx.reply("‚ùóÔ∏è‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ú‡∏¥‡∏î\n‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô: /new [‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà] [‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)]");
    }
    
    if (!isValidIdFormat(newCustomerId)) {
        return ctx.reply(`‚ùå ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô A-Z ‡πÅ‡∏•‡∏∞ 0-9)`);
    }

    const customerExists = await prisma.customer.findUnique({ 
        where: { customerId: newCustomerId, isDeleted: false } 
    });
    if (customerExists) {
        return ctx.reply(`‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ '${newCustomerId}' ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
    }

    if (referrerId && referrerId !== 'N/A') {
        const referrerExists = await prisma.customer.findUnique({ 
            where: { customerId: referrerId, isDeleted: false } 
        });
        if (!referrerExists) {
            return ctx.reply(`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ '${referrerId}' ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
        }
        if (newCustomerId === referrerId) {
            return ctx.reply("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ");
        }
    }
    // ----------------------------------------

    // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Customer ‡πÉ‡∏ô DB ---
    const verificationCode = generateUniqueCode(4); // 4 ‡∏´‡∏•‡∏±‡∏Å
    const initialPoints = 0; 
    const newExpiryDate = addDays(new Date(), 30); // 30 ‡∏ß‡∏±‡∏ô

    await prisma.customer.create({
        data: {
            customerId: newCustomerId,
            referrerId: referrerId,
            points: initialPoints,
            expiryDate: newExpiryDate,
            verificationCode: verificationCode,
            adminCreatedBy: adminUser,
        }
    });

    // --- 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å giveReferralBonus (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ---
    if (referrerId && referrerId !== 'N/A') {
        await giveReferralBonus(referrerId, newCustomerId, adminUser); 
    }
    
    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Dynamic ‡πÅ‡∏•‡∏∞ 5. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
    const campaign = await getActiveCampaign();
    const linkBonusPoints = campaign?.linkBonus || 50; 
    const referralBonusPoints = campaign?.base || 50;
    const customerBotLink = "https://t.me/ONEHUBCustomer_Bot"; // ‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å SystemConfig ‚ö†Ô∏è

    // ... (‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° HTML ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö String)
    const customerMessage = `üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡πà‡∏∞!\n\n` +
      `üë§ <b>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:</b> ${newCustomerId}\n` +
      `üîë <b>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:</b> ${verificationCode}\n\n` +
      `‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå: ${customerBotLink}\n` +
      `‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: <code>/link ${newCustomerId} ${verificationCode}</code>`;

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    ctx.reply(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà '${newCustomerId}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
    // ‚ö†Ô∏è Note: ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÉ‡∏ä‡πâ notification.service.js ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ
    ctx.telegram.sendMessage(chatId, customerMessage, { parse_mode: 'HTML' });
}