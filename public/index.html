<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loyalty Member</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { background-color: var(--tg-theme-bg-color, #18181b); color: var(--tg-theme-text-color, #ffffff); font-family: 'Kanit', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
    </style>
</head>
<body class="min-h-screen p-5 flex flex-col relative overflow-hidden select-none">

    <div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#18181b]">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
        <p class="text-gray-400" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div id="app-content" class="hidden space-y-6 pb-20 w-full max-w-md mx-auto">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center text-2xl">üë§</div>
            <div>
                <h2 id="user-name" class="text-xl font-bold">...</h2>
                <p class="text-xs text-gray-400">ID: <span id="user-id">...</span></p>
            </div>
        </div>

        <div class="glass-card p-6 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-500 rounded-full blur-3xl opacity-20"></div>
            <p class="text-sm text-gray-300">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</p>
            <div class="flex items-baseline gap-2">
                <h1 id="user-points" class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-yellow-500">0</h1>
                <span class="text-yellow-500 font-medium">Points</span>
            </div>
            <p class="text-xs text-gray-400 mt-2">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span id="expiry-date">-</span></p>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div onclick="handleAction('rewards')" class="glass-card p-4 active:scale-95 transition cursor-pointer">
                <i class="ri-gift-2-line text-2xl text-purple-400 mb-2 block"></i>
                <div class="font-bold">‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
                <div class="text-xs text-gray-400">Reward Catalog</div>
            </div>
            <div onclick="handleAction('invite')" class="glass-card p-4 active:scale-95 transition cursor-pointer">
                <i class="ri-user-add-line text-2xl text-green-400 mb-2 block"></i>
                <div class="font-bold">‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</div>
                <div class="text-xs text-gray-400">Get Bonus</div>
            </div>
            
            <div id="btn-link" onclick="openLinkModal()" class="glass-card p-4 active:scale-95 transition cursor-pointer hidden col-span-2 bg-blue-500/10 border-blue-500/30">
                <div class="flex items-center justify-center gap-2">
                    <i class="ri-link-m text-xl text-blue-400"></i>
                    <div>
                        <div class="font-bold text-blue-400">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏Å‡πà‡∏≤</div>
                        <div class="text-[10px] text-gray-400">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏î‡∏¥‡∏°</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="link-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 hidden opacity-0 transition-all duration-300">
        <div class="glass-card p-6 w-[90%] max-w-sm transform scale-95 transition-all" id="link-modal-inner">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl">üîó</div>
                <h3 class="text-xl font-bold">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p class="text-sm text-gray-400">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏î‡∏¥‡∏°</p>
            </div>
            
            <input type="text" id="inp-cust-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÄ‡∏ä‡πà‡∏ô MEM-1234)" class="w-full bg-black/40 border border-gray-600 rounded-xl p-3 mb-3 text-center text-white focus:border-blue-500 outline-none uppercase">
            <input type="tel" id="inp-verify-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å" maxlength="4" class="w-full bg-black/40 border border-gray-600 rounded-xl p-3 mb-6 text-center text-white focus:border-blue-500 outline-none tracking-widest text-lg">
            
            <div class="flex gap-3">
                <button onclick="closeLinkModal()" class="flex-1 py-3 bg-gray-700 rounded-xl text-sm text-gray-300">‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á</button>
                <button onclick="submitLink()" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold shadow-lg shadow-blue-500/30">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // üü¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        async function init() {
            try {
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Magic Link (start_param)
                const startParam = tg.initDataUnsafe?.start_param;
                
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ start_param ‡πÅ‡∏ö‡∏ö 'link_XXX_YYY' ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if (startParam && startParam.startsWith('link_')) {
                    document.getElementById('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...";
                    const parts = startParam.split('_');
                    if (parts.length === 3) {
                        await autoLink(parts[1], parts[2]); // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏•‡∏¢
                        return;
                    }
                }

                // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Link ‡πÉ‡∏´‡πâ Login ‡∏õ‡∏Å‡∏ï‡∏¥
                if (!tg.initData) return runDemoMode();

                const res = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ initData: tg.initData })
                });

                if (!res.ok) throw new Error("Auth Failed");
                const data = await res.json();
                const user = data.customer;

                // Render ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                renderUser(user);
                
                // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                checkLinkStatus(user);

            } catch (err) {
                tg.showAlert("Error: " + err.message);
                location.reload();
            }
        }

        function renderUser(user) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');

            document.getElementById('user-name').innerText = user.firstName;
            document.getElementById('user-id').innerText = user.customerId;
            document.getElementById('user-points').innerText = user.points.toLocaleString();
            if (user.expiryDate) {
                document.getElementById('expiry-date').innerText = new Date(user.expiryDate).toLocaleDateString('th-TH');
            }
        }

        // ‚≠êÔ∏è Logic ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏´‡∏°
        function checkLinkStatus(user) {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏Ñ‡∏£ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà"
            const isUnlinked = user.points === 0 && user.referralCount === 0;

            if (isUnlinked) {
                // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°
                document.getElementById('btn-link').classList.remove('hidden');
                
                // ‡πÄ‡∏î‡πâ‡∏á Popup ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏¢ (‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ App ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô)
                setTimeout(() => openLinkModal(), 600);
            } else {
                // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
                document.getElementById('btn-link').classList.add('hidden');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ó‡∏±‡πâ‡∏á Manual ‡πÅ‡∏•‡∏∞ Auto)
        async function autoLink(custId, vCode) {
            try {
                const res = await fetch('/api/link', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegramId: tg.initDataUnsafe.user.id.toString(),
                        customerId: custId,
                        verificationCode: vCode
                    })
                });
                const result = await res.json();
                
                if (result.success) {
                    tg.showPopup({
                        title: '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        message: `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™: ${result.bonus} ‡πÅ‡∏ï‡πâ‡∏°`,
                        buttons: [{type: 'ok', func: () => location.reload()}] // Reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠ refresh ‡πÅ‡∏ï‡πâ‡∏°
                    });
                } else {
                    tg.showPopup({ title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', message: result.error, buttons: [{type: 'close'}] });
                    // ‡∏ñ‡πâ‡∏≤ Auto Link ‡∏û‡∏•‡∏≤‡∏î (‡πÄ‡∏ä‡πà‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ú‡∏¥‡∏î) ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
                    if(document.getElementById('loading').style.display !== 'none') {
                        location.reload();
                    }
                }
            } catch (e) {
                tg.showAlert("Connection Error");
            }
        }

        // --- UI Control ---
        function openLinkModal() {
            const modal = document.getElementById('link-modal');
            const inner = document.getElementById('link-modal-inner');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                inner.classList.remove('scale-95');
                inner.classList.add('scale-100');
            }, 10);
        }

        function closeLinkModal() {
            const modal = document.getElementById('link-modal');
            const inner = document.getElementById('link-modal-inner');
            modal.classList.add('opacity-0');
            inner.classList.remove('scale-100');
            inner.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function submitLink() {
            const id = document.getElementById('inp-cust-id').value.trim();
            const code = document.getElementById('inp-verify-code').value.trim();
            if(!id || !code) return tg.showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            await autoLink(id, code);
        }

        function handleAction(type) {
            tg.hapticFeedback.impactOccurred('light');
            if (type === 'invite') tg.switchInlineQuery("‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", ["users", "groups"]);
            if (type === 'rewards') tg.showPopup({message: 'Coming Soon!'});
        }

        function runDemoMode() {
            renderUser({ firstName: 'Demo User', customerId: 'TEST-001', points: 0, referralCount: 0, expiryDate: new Date() });
            checkLinkStatus({ points: 0, referralCount: 0 });
        }

        init();
    </script>
</body>
</html>