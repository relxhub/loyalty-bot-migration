<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Member Dashboard</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Styling Library -->


    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ï‡∏≤‡∏° Theme ‡∏Ç‡∏≠‡∏á Telegram ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
        :root {
            --bg-color: #050C0D;
            --text-color: #ffffff;
            --secondary-bg: #161B22;
            --hint-color: #ffffff;
            --button-color: #F22233;
            --button-text: #ffffff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Kanit', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        
        .input-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4b5563;
            transition: all 0.3s;
        }
        .input-box:focus {
            border-color: #3b82f6;
            outline: none;
            background: rgba(0, 0, 0, 0.5);
        }

        /* Animation */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } } 
        
        .bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }

        @keyframes shimmer {
            0% { transform: translateX(-100%) skewX(-12deg); }
            100% { transform: translateX(100%) skewX(-12deg); }
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* --- [START] CSS Notification Toast --- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 90%;
            max-width: 350px;
            pointer-events: none;
        }

        .toast {
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            padding: 14px 16px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: auto;
        }

        .toast.show { opacity: 1; transform: translateY(0) scale(1); }

        /* ‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
        .toast-icon { font-size: 20px; }
        .toast.success .toast-icon { color: #4ade80; text-shadow: 0 0 10px rgba(74,222,128,0.5); }
        .toast.error .toast-icon { color: #f87171; text-shadow: 0 0 10px rgba(248,113,113,0.5); }
        .toast.warning .toast-icon { color: #facc15; text-shadow: 0 0 10px rgba(250,204,21,0.5); }
        .toast.info .toast-icon { color: #60a5fa; text-shadow: 0 0 10px rgba(96,165,250,0.5); }

        /* ‡∏õ‡∏∏‡πà‡∏° Refresh ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô */
        .header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .refresh-btn {
            background: rgba(2, 2, 2, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .refresh-btn:active { transform: scale(0.9) rotate(180deg); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        /* --- [END] CSS Notification Toast --- */

        /* ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Modal */
        body.no-scroll {
            overflow: hidden !important;
            position: fixed; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÜ */
            width: 100%;
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß Popup ‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏∞‡∏•‡∏∏‡∏î‡πâ‡∏ß‡∏¢ CSS ‡∏™‡∏°‡∏±‡∏¢‡πÉ‡∏´‡∏°‡πà */
        #history-modal .overflow-y-auto {
            overscroll-behavior: contain; /* ‡∏™‡∏±‡πà‡∏á‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß "‡∏´‡πâ‡∏≤‡∏°" ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÑ‡∏•‡∏î‡πå‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á */
        }

        .list-item-animate {
            animation: slideIn 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tier2-list {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .item-hover-effect:hover {
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.1);
        }

        /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        #bottom-nav {
            transition: transform 0.3s ease-in-out;
        }
        #bottom-nav.hide {
            transform: translateY(150%); /* ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        }

        /* Styling for QR Code */
        #qr-code-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 20px;
            background: transparent; /* QR Code ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡∏•‡∏á canvas/div */
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
        }
        #qr-code-container canvas {
            border-radius: 12px; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ QR Code ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô */
        }

        .download-qr-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .download-qr-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .download-qr-btn:active {
            transform: scale(0.98);
        }

    </style>
</head>
<body class="min-h-screen flex flex-col p-5 select-none overflow-x-hidden">

    <div class="header-actions">
        <button class="refresh-btn" onclick="manualRefresh(); try { Telegram.WebApp.hapticFeedback.impactOccurred('medium'); } catch(e){}">
            <i class="ri-refresh-line text-xl"></i>
        </button>
    </div>

    <div id="toast-container"></div>

    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#050C0D]">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-400 animate-pulse" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div id="login-screen" class="hidden fixed inset-0 z-40 bg-[#050C0D] flex flex-col items-center justify-center p-6">
        <div class="glass-card p-8 w-full max-w-sm text-center shadow-2xl relative overflow-hidden fade-in">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-[#F22233]/20 rounded-full blur-3xl"></div>
            
            <div class="w-20 h-20 bg-gradient-to-tr from-[#F2A71B] to-[#F28627] text-white rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-lg relative z-10">
                üîó
            </div>
            
            <h2 class="text-2xl font-bold mb-2 text-white relative z-10">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h2>
            <p class="text-gray-400 text-sm mb-8 relative z-10">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>

            <div class="space-y-4 text-left relative z-10">
                <div>
                    <label class="text-xs text-gray-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                    <input type="text" id="login-cust-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô OT99999" class="w-full input-box rounded-xl p-4 text-white text-center tracking-wider uppercase text-lg placeholder-gray-600">
                </div>
                <div>
                    <label class="text-xs text-gray-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å</label>
                    <input type="tel" id="login-verify-code" maxlength="4" placeholder="XXXX" class="w-full input-box rounded-xl p-4 text-white text-center tracking-[0.5em] text-xl placeholder-gray-600">
                </div>
            </div>
            
            <button onclick="submitLogin()" class="w-full mt-8 py-4 bg-gradient-to-r from-[#F22233] to-[#F24E29] hover:from-blue-500 hover:to-blue-400 rounded-xl font-bold text-lg text-white shadow-lg shadow-[#F22233]/30 transition active:scale-95 relative z-10">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
            
            <p class="text-[10px] text-gray-600 mt-6 relative z-10">
                *‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            </p>
        </div>
    </div>

    <div id="app-content" class="hidden w-full max-w-md mx-auto space-y-6 pb-32 fade-in">

        <div class="flex justify-center mb-4">
            <img src="logo.png" alt="Company Logo" class="w-48">
        </div>
        
        <div class="flex items-center space-x-4">
            <div class="relative">
                <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#F2A71B] to-[#F28627] flex items-center justify-center text-4xl shadow-lg shadow-blue-500/20">
                    üë§
                </div>
                <div class="absolute -bottom-1 -right-1 bg-green-500 w-4 h-4 rounded-full border-2 border-[#18181b]"></div>
            </div>
            <div>
                <h2 id="user-name" class="text-xl font-bold leading-tight">...</h2>
                <p class="text-xs text-gray-400">ID: <span id="user-id">...</span></p>
            </div>
        </div>

        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <i class="ri-vip-diamond-line text-9xl"></i>
            </div>
            
            <p class="text-sm text-gray-300 mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div class="flex items-baseline space-x-2">
                <h1 id="user-points" class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#F2A71B] to-[#F28627]">0</h1>
                <span class="text-sm text-yellow-500 font-medium">Points</span>
            </div>
            
            <div class="mt-4 flex justify-between items-end">
                <div class="text-xs text-gray-400">
                    ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span id="expiry-date" class="text-white">...</span>
                </div>
                <button 
                    onclick="openHistoryModal(); try { Telegram.WebApp.hapticFeedback.impactOccurred('medium'); } catch(e){}" 
                    class="bg-white/5 hover:bg-white/10 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 transition group">
                    
                    <div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-xl group-hover:scale-110 transition">
                        <i class="ri-history-line"></i>
                    </div>
                    <span class="text-xs font-medium text-gray-300">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
                </button>
            </div>
        </div>

        <!-- [START] Mission/Campaign Box (Conditional) -->
        <div id="mission-box" onclick="openCampaignModal()" class="glass-card p-5 hidden relative overflow-hidden border border-yellow-500/50 shadow-[0_0_15px_rgba(234,179,8,0.15)] group transition active:scale-95 cursor-pointer">
            <!-- Sparkle Effect -->
            <div class="absolute -top-10 -right-10 w-20 h-20 bg-yellow-500/20 rounded-full blur-2xl animate-pulse"></div>
            
            <div class="flex justify-between items-start mb-3 relative z-10">
                <div>
                    <div class="font-bold text-sm text-yellow-400 flex items-center gap-2">
                        <i class="ri-flashlight-fill animate-pulse"></i> <span id="mission-name">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
                    </div>
                    <div class="text-[10px] text-yellow-200/70 mt-0.5" id="mission-dates">...</div>
                </div>

                <div class="flex items-center gap-2">
                    <!-- Silver Badge: Base Referral -->
                    <span id="mission-base-badge" class="text-[10px] bg-slate-600/30 text-slate-200 border border-slate-400/30 px-2 py-1 rounded-lg backdrop-blur-sm shadow-sm">
                        ‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô +50
                    </span>

                    <!-- Gold Badge: Bonus (Sparkling) -->
                    <span id="mission-bonus-badge" class="relative text-[10px] bg-gradient-to-br from-yellow-500/30 to-yellow-600/10 text-yellow-200 border border-yellow-400/50 px-2 py-1 rounded-lg shadow-[0_0_15px_rgba(234,179,8,0.4)] overflow-hidden">
                        <span class="relative z-10">‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +50</span>
                        <div class="absolute inset-0 bg-white/40 w-full h-full -skew-x-12 translate-x-[-150%] animate-[shimmer_3s_infinite]"></div>
                    </span>
                </div>
            </div>
            
            <div class="relative z-10 pt-2">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ</span>
                        <span id="mission-current" class="text-3xl font-bold text-white leading-none">0</span>
                    </div>

                    <div class="h-8 w-[1px] bg-white/10"></div>

                    <div class="flex flex-col items-end">
                        <span class="text-[10px] text-gray-400">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
                        <span id="mission-target" class="text-3xl font-bold text-yellow-400 leading-none">5</span>
                    </div>
                </div>

                <div class="bg-white/5 rounded-lg p-2 flex items-center justify-between border border-white/5">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center text-xs">
                            <i class="ri-gift-fill"></i>
                        </div>
                        <span id="mission-desc" class="text-[10px] text-gray-300">‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏Ñ‡∏ô ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™</span>
                    </div>
                    <span id="mission-status-text" class="text-[9px] text-yellow-500/80 font-mono">ON GOING</span>
                </div>
            </div>
        </div>
        <!-- [END] Mission Box -->

        <!-- [START] Friends You Referred Box (Always Visible) -->
        <div class="glass-card p-5 group cursor-pointer transition active:scale-95" onclick="openReferralModal(); try { Telegram.WebApp.hapticFeedback.impactOccurred('medium'); } catch(e){}">
            <div class="mb-4 font-semibold text-sm flex items-center gap-2 text-blue-100">
                <i class="ri-team-fill text-[#F22233]"></i> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
            </div>
            <div class="grid grid-cols-2 gap-4 relative">
                <!-- Vertical Divider -->
                <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[1px] h-8 bg-white/10"></div>

                <div class="text-center group">
                    <div class="text-[10px] text-gray-400 mb-1 group-hover:text-blue-300 transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div class="text-2xl font-bold text-white tracking-wide" id="referral-total-all">0</div>
                </div>

                <div class="text-center group">
                    <div class="text-[10px] text-gray-400 mb-1 group-hover:text-green-300 transition">‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                    <div class="text-2xl font-bold text-green-400 tracking-wide" id="referral-total-month">0</div>
                </div>
            </div>
        </div>
        <!-- [END] Friends Box -->

        <!-- [START] Rewards & Invite Box -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="openRewardsModal()" class="glass-card p-4 hover:bg-white/10 transition active:scale-95 text-left group">
                <div class="w-10 h-10 rounded-full bg-[#F22233]/20 flex items-center justify-center text-[#F22233] mb-3 group-hover:scale-110 transition">
                    <i class="ri-gift-2-line text-xl"></i>
                </div>
                <div class="font-semibold">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
                <div class="text-xs text-gray-400">‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
            </button>

            <button onclick="openInviteModal()" class="glass-card p-4 hover:bg-white/10 transition active:scale-95 text-left group">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 mb-3 group-hover:scale-110 transition">
                    <i class="ri-user-add-line text-xl"></i>
                </div>
                <div class="font-semibold">‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</div>
                <div class="text-xs text-gray-400">‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©</div>
            </button>
        </div>
        <!-- [END] Rewards & Invite Box -->


    </div>

    <div id="link-modal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 hidden opacity-0 transition-opacity duration-300">
        <div class="glass-card p-6 w-[90%] max-w-sm scale-95 transition-transform duration-300 transform" id="link-modal-content">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-[#F22233]/20 text-[#F22233] rounded-full flex items-center justify-center mx-auto mb-3 text-3xl">üîó</div>
                <h3 class="text-xl font-bold mb-2 text-white">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                <p class="text-sm text-gray-400 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <input type="text" id="link-cust-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô MEM-888888" class="w-full bg-black/30 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:border-[#F22233] text-center tracking-wider uppercase">
                </div>
                <div>
                    <label class="text-xs text-gray-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å</label>
                    <input type="tel" id="verify-code" maxlength="4" placeholder="XXXX" class="w-full bg-black/30 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:border-[#F22233] text-center tracking-[0.5em] text-lg">
                </div>
            </div>
            
            <div class="flex space-x-3 mt-8">
                <button onclick="closeLinkModal()" class="flex-1 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 transition text-sm">‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á</button>
                <button onclick="submitLinkAccount()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-[#F22233] to-[#F24E29] hover:from-blue-500 hover:to-blue-400 font-bold transition shadow-lg shadow-[#F22233]/30">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div id="invite-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div class="glass-card w-full max-w-md p-6 rounded-t-3xl sm:rounded-2xl flex flex-col transform translate-y-full transition-transform duration-300" id="invite-content">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="ri-user-add-line text-[#F22233]"></i> ‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                </h3>
                <button onclick="closeInviteModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition text-white">
                    <i class="ri-close-line"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div class="bg-white/5 p-4 rounded-xl border border-white/10 text-center">
                    <p class="text-sm text-gray-400 mb-2">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    <div class="flex items-center gap-2 bg-black/30 p-2 rounded-lg">
                        <input type="text" id="invite-link" readonly class="bg-transparent w-full text-sm text-green-400 font-mono outline-none text-center">
                        <button onclick="copyInviteLink()" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition text-white">
                            <i class="ri-file-copy-line"></i>
                        </button>
                    </div>

                    <!-- QR Code Display -->
                    <div id="qr-code-container" class="mt-4"></div>
                    <button id="download-qr-btn" class="download-qr-btn w-full mt-3"><i class="ri-download-line"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î QR Code</button>
                </div>

                <button onclick="universalShare()" id="universal-share-btn" class="w-full py-3 bg-gradient-to-r from-[#F22233] to-[#F24E29] hover:from-blue-500 hover:to-blue-400 rounded-xl font-bold text-white shadow-lg shadow-[#F22233]/30 transition active:scale-95 flex items-center justify-center gap-2">
                    <i class="ri-share-forward-fill text-xl"></i> ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                </button>

                <div id="fallback-share-container" class="hidden space-y-3">
                    <button onclick="shareOnTelegram()" class="w-full py-3 bg-[#2AABEE] hover:bg-[#279cda] rounded-xl font-bold text-white transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="ri-telegram-fill text-xl"></i> ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏õ Telegram
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="shareOnLine()" class="w-full py-3 bg-[#06C755] hover:bg-[#05b34c] rounded-xl font-bold text-white transition active:scale-95 flex items-center justify-center gap-2">
                            <i class="ri-line-fill text-xl"></i> LINE
                        </button>
                        <button onclick="shareOnWhatsApp()" class="w-full py-3 bg-[#25D366] hover:bg-[#22bf5b] rounded-xl font-bold text-white transition active:scale-95 flex items-center justify-center gap-2">
                            <i class="ri-whatsapp-fill text-xl"></i> WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rewards Modal -->
    <div id="rewards-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div class="glass-card w-full max-w-md h-[85vh] sm:h-[650px] rounded-t-3xl sm:rounded-2xl flex flex-col transform translate-y-full transition-transform duration-300" id="rewards-content">

            <div class="p-6 border-b border-gray-700 bg-gradient-to-r from-[#F22233]/50 to-[#F24E29]/50 rounded-t-3xl sm:rounded-t-2xl">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold flex items-center gap-2 text-white">
                        <i class="ri-gift-line text-[#F22233]"></i> ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
                    </h3>
                    <button onclick="closeRewardsModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition text-white">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏Å‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>

            <div id="rewards-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div class="text-center text-gray-500 mt-10 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•...</div>
            </div>
        </div>
    </div>

    <div id="success-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-sm p-6">
        <div class="glass-card p-8 w-full max-w-sm text-center shadow-2xl relative overflow-hidden fade-in">
            <div class="absolute inset-0 bg-green-500/10"></div>
            
            <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl shadow-[0_0_30px_rgba(34,197,94,0.4)] relative z-10 bounce-in">
                üéâ
            </div>
            
            <h2 class="text-3xl font-bold mb-2 text-white relative z-10">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</h2>
            <p class="text-gray-300 mb-8 relative z-10" id="success-msg">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 100 ‡πÅ‡∏ï‡πâ‡∏°</p>
            
            <button onclick="closeSuccessModal()" class="w-full py-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-lg text-white shadow-lg transition active:scale-95 relative z-10">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
        </div>
    </div>

    <div id="history-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div class="glass-card w-full max-w-md h-[80vh] sm:h-[600px] rounded-t-3xl sm:rounded-2xl flex flex-col transform translate-y-full transition-transform duration-300" id="history-content">
            
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-black/20">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="ri-history-line text-blue-400"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                </h3>
                <button onclick="closeHistoryModal()" class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center hover:bg-gray-700 transition">
                    <i class="ri-close-line"></i>
                </button>
            </div>

            <div id="history-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div class="text-center text-gray-500 mt-10 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>
    </div>

    <!-- Campaign Detail Modal -->
    <div id="campaign-modal" class="hidden fixed inset-0 z-[65] flex items-center justify-center bg-black/90 backdrop-blur-md opacity-0 transition-opacity duration-300 p-6">
        <div class="glass-card w-full max-w-md p-0 overflow-hidden transform scale-95 transition-transform duration-300 relative border border-yellow-500/30 shadow-[0_0_50px_rgba(234,179,8,0.2)]" id="campaign-content">

            <!-- Close Button -->
            <button onclick="closeCampaignModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/50 text-white/70 flex items-center justify-center hover:bg-white/10 transition">
                <i class="ri-close-line"></i>
            </button>

            <!-- Header Image/Gradient -->
            <div class="h-32 bg-gradient-to-br from-yellow-700 via-yellow-600 to-yellow-900 relative flex items-center justify-center overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-30"></div>
                <div class="w-20 h-20 rounded-full bg-yellow-400/20 backdrop-blur-md flex items-center justify-center text-4xl shadow-[0_0_20px_rgba(250,204,21,0.5)] border border-yellow-300/50 animate-bounce">
                    ‚ö°Ô∏è
                </div>
            </div>

            <!-- Body -->
            <div class="p-6 pt-12 -mt-6 bg-[#18181b] rounded-t-3xl relative z-10">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-yellow-400 mb-1" id="modal-camp-name">Campaign Name</h3>
                    <p class="text-xs text-gray-400 flex justify-center items-center gap-2">
                        <i class="ri-calendar-event-line"></i> <span id="modal-camp-dates">... - ...</span>
                    </p>
                </div>

                <div class="space-y-4">
                    <!-- Rule 1: Per Person -->
                    <div class="flex items-center gap-4 bg-white/5 p-4 rounded-xl border border-white/10">
                        <div class="w-12 h-12 rounded-full bg-[#F22233]/20 text-[#F22233] flex items-center justify-center text-xl">
                            <i class="ri-user-add-line"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-gray-200">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô 1 ‡∏Ñ‡∏ô</div>
                            <div class="text-xs text-gray-400">‡∏£‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ <span class="text-[#F22233] font-bold text-sm" id="modal-camp-base">50</span> ‡πÅ‡∏ï‡πâ‡∏°</div>
                        </div>
                    </div>

                    <!-- Rule 2: Milestone -->
                    <div class="flex items-center gap-4 bg-gradient-to-r from-yellow-900/20 to-black p-4 rounded-xl border border-yellow-500/20 relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-1 bg-yellow-500"></div>
                        <div class="w-12 h-12 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center text-xl shadow-[0_0_15px_rgba(234,179,8,0.3)]">
                            <i class="ri-gift-fill"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-yellow-200" id="modal-camp-target-title">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©!</div>
                            <div class="text-xs text-yellow-200/70" id="modal-camp-bonus-desc">‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏ô ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° 500 ‡πÅ‡∏ï‡πâ‡∏°</div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button onclick="closeCampaignModal(); handleAction('invite');" class="w-full py-3 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-black font-bold rounded-xl shadow-lg shadow-yellow-500/20 transition active:scale-95">
                        ‡∏•‡∏∏‡∏¢‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏•‡∏¢!
                    </button>
                    <p class="text-[10px] text-gray-500 mt-3">*‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
                </div>
            </div>
        </div>
    </div>

    <div id="referral-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div class="glass-card w-full max-w-md h-[85vh] sm:h-[650px] rounded-t-3xl sm:rounded-2xl flex flex-col transform translate-y-full transition-transform duration-300" id="referral-content">
            
            <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-black/20">
                <h3 class="text-xl font-bold flex items-center gap-2 text-white">
                    <i class="ri-team-line text-[#F22233]"></i> ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                </h3>
                <button onclick="closeReferralModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition text-white">
                    <i class="ri-close-line"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3 p-4">
                <div class="bg-white/5 rounded-xl p-3 text-center border border-white/10">
                    <div class="text-xs text-gray-400">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
                    <div class="text-2xl font-bold text-white tracking-wide" id="ref-total-count">0</div>
                </div>
                <div class="bg-white/5 rounded-xl p-3 text-center border border-white/10">
                    <div class="text-xs text-gray-400">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ)</div>
                    <div class="text-2xl font-bold text-green-400 tracking-wide" id="ref-total-earned">0</div>
                </div>
            </div>

            <div id="referral-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <div class="text-center text-gray-500 mt-10 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥...</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        // 1. ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
        tg.expand(); 

        // 2. ‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏±‡∏î‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô v7.7)
        if (tg.isVersionAtLeast('7.7')) {
            tg.disableVerticalSwipes();
        }

        // 3. ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ú‡∏•‡∏≠‡∏õ‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô (Confirmation Dialog)
        tg.enableClosingConfirmation();

        // --- [START] Helper Functions ---

        // NEW: Client-side configuration store
        window.appConfig = {
            orderBotUsername: '' // This is fetched from the backend via the /api/auth response
        };

        function getConfig(key, defaultValue = '') {
            return window.appConfig[key] || defaultValue;
        }

        // Global User Cache
        window.currentUser = null;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            
            // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            let icon = '';
            switch(type) {
                case 'success': icon = '<i class="ri-checkbox-circle-fill"></i>'; break;
                case 'error': icon = '<i class="ri-close-circle-fill"></i>'; break;
                case 'warning': icon = '<i class="ri-alert-fill"></i>'; break;
                default: icon = '<i class="ri-information-fill"></i>';
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;

            container.appendChild(toast);
            
            // ‡∏™‡∏±‡πà‡∏ô‡πÄ‡∏ö‡∏≤‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            try { tg.hapticFeedback.notificationOccurred(type === 'error' ? 'error' : 'success'); } catch(e){}

            requestAnimationFrame(() => toast.classList.add('show'));

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 4000); // ‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≤‡∏ô 4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        }

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ô‡∏Å‡∏î‡∏£‡∏±‡∏ß (Cool-down flag)
        let isRefreshCooldown = false;

        async function manualRefresh() {
            // 1. ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î Cool-down ‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏Å‡∏î‡πÑ‡∏õ) ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (isRefreshCooldown) return;

            const btn = document.querySelector('.refresh-btn');
            
            // 2. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà Effect ‡∏´‡∏°‡∏∏‡∏ô
            isRefreshCooldown = true;
            btn.style.animation = 'spin 1s linear infinite'; 
            btn.style.opacity = '0.5'; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏á‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            btn.style.cursor = 'not-allowed'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏´‡πâ‡∏≤‡∏°

            try {
                // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏™‡πà await ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á)
                await refreshUserData(true); 
                showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
            } catch (error) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            } finally {
                // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß... "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"
                // ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏≠‡∏µ‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏õ‡∏°
                setTimeout(() => {
                    isRefreshCooldown = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
                    btn.style.animation = 'none'; // ‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏°‡∏∏‡∏ô
                    btn.style.opacity = '1'; // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ä‡∏±‡∏î
                    btn.style.cursor = 'pointer'; // ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
                }, 3000); // 3000ms = 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡∏ä‡∏≠‡∏ö)
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° & ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
        function checkNotifications(user, isAutoRefresh) {
        // 1. ‡∏î‡∏∂‡∏á‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        const lastPoints = parseInt(localStorage.getItem('last_points'));
        
        // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏Å‡πà‡∏≤ ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°)
        if (!isNaN(lastPoints) && user.points !== lastPoints) {
        
            const diff = user.points - lastPoints;

            if (diff > 0) {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°
                showToast(`üéâ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° ${diff} ‡πÅ‡∏ï‡πâ‡∏°`, 'success');
                try { tg.hapticFeedback.notificationOccurred('success'); } catch(e){}
            } else {
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ï‡πâ‡∏°‡∏•‡∏î (diff ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
                // showToast(`üîª ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${Math.abs(diff)} ‡πÅ‡∏ï‡πâ‡∏°`, 'info'); 
                // ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡πá‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            }
        }

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
        localStorage.setItem('last_points', user.points);

        // 4. (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°...)
        if (user.expiryDate && !isAutoRefresh) { // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏û‡∏≠
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ...
        }
        }

        function showReferralInstructions() {
            if (!window.currentUser || !window.currentUser.customerId) {
                tg.showAlert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
                return;
            }
            
            const customerId = window.currentUser.customerId;
            const message = `‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${customerId}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© 10%`;
            
            tg.showAlert(message);
        }
        // --- [END] Helper Functions ---

        tg.enableClosingConfirmation(); 

        async function initApp() {
            try {
                const startParam = tg.initDataUnsafe?.start_param;
                console.log(`[Init] start_param received: ${startParam}`);

                if (startParam) {
                    if (startParam.startsWith('app-ref_')) {
                        console.log("[Init] New format referral link detected.");
                        const referrerId = startParam.substring('app-ref_'.length);
                        await handleReferralFlow(referrerId);
                        return;
                    } else if (startParam.startsWith('ref_')) {
                        console.log("[Init] Old format referral link detected.");
                        const referrerId = startParam.split('_')[1];
                        await handleReferralFlow(referrerId);
                        return; 
                    } else if (startParam.startsWith('link_')) {
                        console.log("[Init] Magic link detected.");
                        document.getElementById('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...";
                        const parts = startParam.split('_');
                        if (parts.length === 3) {
                            await performLink(parts[1], parts[2]); 
                            return;
                        }
                    }
                }

                // Case 1 (Normal entry or if other params fail)
                console.log("[Init] Normal entry. Refreshing user data.");
                await refreshUserData();

            } catch (error) {
                console.error("Critical Error in initApp:", error);
                showToast(error.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", 'error');
                showLoginScreen(); // Fallback to login screen
            }
        }

        async function handleReferralFlow(referrerId) {
            document.getElementById('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...";
            console.log(`[Referral Flow] Started. Referrer ID: ${referrerId}`);
            try {
                const user = tg.initDataUnsafe?.user;
                if (!user) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Telegram ‡πÑ‡∏î‡πâ");
                }

                // First, check if the Telegram user is already a member
                console.log("[Referral Flow] Checking auth status...");
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                
                // Check if the response is OK before parsing JSON
                if (!response.ok) {
                    const errorData = await response.json();
                    // If it's a 401 or 404, show the login screen
                    if (response.status === 401 || response.status === 404) {
                        throw new Error(errorData.message || "Authentication failed. Please log in again.");
                    } else {
                        // For other errors, just log and show a generic message
                        throw new Error(`Request failed: ${response.statusText}`);
                    }
                }
                
                const authData = await response.json();
                console.log("[Referral Flow] Auth response:", authData);

                if (authData.isMember) {
                    // User is already a member
                    console.log("[Referral Flow] User is already a member. Showing dashboard.");
                    showToast("‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà", "info");
                    window.currentUser = authData.customer;
                    renderUser(authData.customer); // Go to dashboard
                } else {
                    // User is not a member, proceed with automatic referral registration
                    console.log("[Referral Flow] New user detected. Attempting automatic registration...");
                    document.getElementById('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà...";
                    
                    try {
                        await handleReferralRegistration(referrerId);
                    } catch (regError) {
                        console.error("Registration failed, but continuing to refresh data.", regError);
                        // Even if registration fails (e.g., race condition), 
                        // we still want to try refreshing the user data one last time.
                    }

                    console.log("[Referral Flow] Registration attempt finished. Refreshing user data...");
                    await refreshUserData();
                }
            } catch (error) {
                console.error("Critical Error in Referral Flow:", error);
                showToast(error.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", 'error');
                showLoginScreen(); // Fallback to login screen
            }
        }

        async function handleReferralRegistration(referrerId) {
            try {
                const user = tg.initDataUnsafe?.user;
                if (!user) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Telegram ‡πÑ‡∏î‡πâ");
                }

                const response = await fetch('/api/referral/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        referrerId: referrerId,
                        telegramId: user.id.toString(),
                        firstName: user.first_name,
                        lastName: user.last_name || null,
                        username: user.username || null
                    })
                });
                
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || "‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
                } else {
                    // Redirect to welcome page instead of showing a toast
                    window.location.href = `/welcome.html?customerId=${result.refereeCustomerId}`;
                }
            } catch (error) {
                console.error("Referral Registration Failed:", error);
                showToast(error.message, 'error');
                // The handleReferralFlow will call refreshUserData or showLoginScreen based on result
                throw error; // Re-throw to be caught by handleReferralFlow's catch block
            }
        }


        // ‡∏£‡∏±‡∏ö Parameter isSilent (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô true ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ)
        async function refreshUserData(isSilent = false) {
            let user;
            let isMember = false;

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å) ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå Loading
            if (!isSilent) {
                document.getElementById('loading-screen').classList.remove('hidden');
            }

            if (!tg.initData) {
                // --- DEMO MODE ---
                // If Telegram Web App data is not available (e.g. running in a browser directly),
                // simulate a logged-in state for demonstration purposes.
                console.log("[Init] DEMO MODE: Telegram Web App data not available.");
                isMember = false; 
                user = { firstName: "Demo", customerId: "MEM-9999", points: 0, referralCount: 0 };
            } else {
                try {
                    const response = await fetch('/api/auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData })
                    });
                    
                    // Check if the response is OK before parsing JSON
                    if(!response.ok) {
                        const errorData = await response.json();
                        // If it's a 401 or 404, show the login screen
                        if (response.status === 401 || response.status === 404) {
                            throw new Error(errorData.message || "Authentication failed. Please log in again.");
                        } else {
                            // For other errors, just log and show a generic message
                            throw new Error(`Request failed: ${response.statusText}`);
                        }
                    }
                    
                    const data = await response.json();
                    isMember = data.isMember;
                    user = data.customer;

                    // Dynamically update the bot username from the backend response
                    if (user && user.orderBotUsername) {
                        window.appConfig.orderBotUsername = user.orderBotUsername;
                    }
                } catch (e) {
                    console.error("Error fetching user data:", e);
                    // If there's an error, show the login screen unless it's a silent refresh
                    if (!isSilent) {
                        showToast(e.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", 'error');
                        showLoginScreen();
                    } else {
                        // For silent refreshes, if user data fetch fails, we simply stop.
                        // This might happen if the token expires or network issues occur.
                    }
                    return; // Stop execution if there was an error
                }
            }

            // Close Loading Screen
            document.getElementById('loading-screen').classList.add('hidden');

            if (isMember) {
                window.currentUser = user; // Cache User Data
                renderUser(user);
                checkNotifications(user, isSilent);
            } else {
                if (!isSilent) showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('success-modal').classList.add('hidden'); // Hide success modal if visible
            document.getElementById('link-modal').classList.add('hidden');   
            document.getElementById('invite-modal').classList.add('hidden'); // Hide invite modal if visible
            document.getElementById('rewards-modal').classList.add('hidden'); // Hide rewards modal if visible
            document.getElementById('campaign-modal').classList.add('hidden'); // Hide campaign modal if visible
            document.getElementById('referral-modal').classList.add('hidden'); // Hide referral modal if visible

            document.getElementById('login-screen').classList.remove('hidden');

            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) refreshBtn.classList.add('hidden');
        }


        function renderUser(user) {
            // Hide other screens, show dashboard
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');

            document.getElementById('user-name').innerText = `${user.firstName} ${user.lastName || ''}`.trim();
            
            // --- New logic for pending referral badge ---
            const userIdElement = document.getElementById('user-id');
            const userInfoContainer = userIdElement.parentElement.parentElement; // The containing div

            // Remove any existing badge first to avoid duplicates on refresh
            const existingBadge = userInfoContainer.querySelector('.pending-badge');
            if (existingBadge) {
                userInfoContainer.removeChild(existingBadge);
            }

            // Set the user ID
            userIdElement.innerText = user.customerId || 'N/A';

            // If the user is a pending referral, add the clickable badge
            if (user.isPendingReferral) {
                const badge = document.createElement('button');
                // Place it below the ID line with margin-top for alignment
                badge.className = 'pending-badge mt-2 px-2 py-1 bg-yellow-500/20 text-yellow-300 text-[10px] rounded-md font-mono flex items-center gap-1';
                badge.innerHTML = 'üéÅ <span>‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>';
                badge.onclick = () => showReferralInstructions();
                userInfoContainer.appendChild(badge);
            }
            // --- End new logic ---

            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) refreshBtn.classList.remove('hidden');
            if (refreshBtn) refreshBtn.classList.remove('hidden');
            // -----------------------------------------------------
            // ‚úÖ [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏° (Logic ‡πÄ‡∏î‡∏¥‡∏°)
            // -----------------------------------------------------
            const pointsEl = document.getElementById("user-points");
            
            // Debug: ‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Console (‡∏Å‡∏î F12 ‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
            console.log(`Points Debug -> Current: "${pointsEl.innerText}", API: ${user.points}`);

            // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
            let currentPoints = 0;
            try {
                currentPoints = parseInt(pointsEl.innerText.replace(/,/g, '')) || 0;
            } catch(e) {
                currentPoints = 0;
            }
            
            // 2. ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á Animation
            if (currentPoints !== user.points) {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Animation
                animateValue("user-points", currentPoints, user.points, 1000);
                
                // üî• ‡∏ï‡∏±‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß: ‡∏ñ‡πâ‡∏≤ Animation ‡∏û‡∏±‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ 1.1 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏¢
                setTimeout(() => {
                    const finalCheck = document.getElementById("user-points");
                    if (finalCheck.innerText !== user.points.toLocaleString()) {
                        finalCheck.innerText = user.points.toLocaleString();
                    }
                }, 1100);
            }
            
            if(user.expiryDate) {
                const date = new Date(user.expiryDate);
                document.getElementById('expiry-date').innerText = date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
            }

            // -----------------------------------------------------
            // üöÄ [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2] Logic ‡πÉ‡∏´‡∏°‡πà V2: ‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
            // -----------------------------------------------------

            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥" (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤)
            const totalRefs = (user.totalReferrals !== undefined) ? user.totalReferrals : (user.referralCount || 0);
            const monthRefs = user.referralCountMonth || 0; // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å API

            const elTotalAll = document.getElementById('referral-total-all');
            if(elTotalAll) elTotalAll.innerText = totalRefs.toLocaleString();

            const elTotalMonth = document.getElementById('referral-total-month');
            if(elTotalMonth) elTotalMonth.innerText = monthRefs.toLocaleString();

            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á "‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô" (Mission Box)
            const missionBox = document.getElementById('mission-box');
            const isCampaign = user.activeCampaignTag && user.activeCampaignTag !== 'Standard';

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (Pre-active 3 days)
            let isComingSoon = false;
            let startTime = null;
            if (user.campaignStartAt) {
                startTime = new Date(user.campaignStartAt).getTime();
                const now = new Date().getTime();
                const diffDays = (startTime - now) / (1000 * 60 * 60 * 24);
                if (diffDays > 0 && diffDays <= 3) isComingSoon = true;
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ñ‡πâ‡∏≤: ‡πÄ‡∏õ‡πá‡∏ô Campaign Active ‡∏´‡∏£‡∏∑‡∏≠ ‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° (Coming Soon)
            if (missionBox) {
                if ((isCampaign && user.referralTarget > 0) || isComingSoon) {
                    missionBox.classList.remove('hidden');

                    const campaignName = user.activeCampaignTag || 'Upcoming Event';
                    const target = user.referralTarget || 5;
                    const bonus = user.milestoneBonus || 0;
                    const basePoints = user.referralBasePoints || 50;
                    const current = user.campaignReferralCount || 0;

                    // Set Texts
                    document.getElementById('mission-name').innerText = campaignName;
                    // Note: bonus badge has internal structure now, better to update textContent carefully or innerHTML if simple
                    // But here we have <span class="relative z-10">...</span> inside.
                    const bonusBadge = document.getElementById('mission-bonus-badge');
                    if (isComingSoon) {
                        bonusBadge.querySelector('span.relative').innerText = '‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ';
                    } else {
                        bonusBadge.querySelector('span.relative').innerText = `‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +${bonus}`;
                    }

                    document.getElementById('mission-base-badge').innerText = `‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô +${basePoints}`;

                    // Set Dates
                    if (user.campaignStartAt && user.campaignEndAt) {
                         const dStart = new Date(user.campaignStartAt);
                         const dEnd = new Date(user.campaignEndAt);
                         const fmt = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                         document.getElementById('mission-dates').innerText = `${dStart.toLocaleDateString('th-TH', fmt)} - ${dEnd.toLocaleDateString('th-TH', fmt)}`;
                    } else {
                         document.getElementById('mission-dates').innerText = '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î';
                    }

                    if (isComingSoon) {
                         document.getElementById('mission-desc').innerText = '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©';
                         document.getElementById('mission-current').innerText = '-';
                         document.getElementById('mission-target').innerText = '-';
                    } else {
                         // Logic Recurring:
                         // Current = Campaign Specific Count (e.g. 7)
                         // Target Base = 5
                         // Effective Target = 10 (Next Milestone)

                         const effectiveTarget = (Math.floor(current / target) + 1) * target;

                         document.getElementById('mission-current').innerText = current;
                         document.getElementById('mission-target').innerText = effectiveTarget;
                         document.getElementById('mission-desc').innerText = `‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÜ ${target} ‡∏Ñ‡∏ô ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™`;
                    }

                } else {
                    missionBox.classList.add('hidden');
                }
            }
            // -----------------------------------------------------
        }

        // --- Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Link) ---
        async function performLink(customerId, verificationCode) {
            try {
                const response = await fetch('/api/link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegramId: tg.initDataUnsafe.user?.id.toString() || "DEMO",
                        customerId: customerId,
                        verificationCode: verificationCode,
                        initData: tg.initData // Pass initData for verification on backend
                    })
                });

                const result = await response.json();
                document.getElementById('loading-screen').classList.add('hidden');

                if (response.ok && result.success) {
                    showToast(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™ ${result.bonus} ‡πÅ‡∏ï‡πâ‡∏°`, 'success');
                    showSuccessModal(result.bonus);
                } else {
                    // If response is not ok, use the error message from the JSON body
                    showToast(result.error || "‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô", 'error');
                    showLoginScreen();
                }
            } catch (error) {
                console.error("Link Error:", error);
                document.getElementById('loading-screen').classList.add('hidden');
                
                showToast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", 'error');
                showLoginScreen();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Success Modal
        function showSuccessModal(bonus) {
            document.getElementById('success-msg').innerText = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${bonus} ‡πÅ‡∏ï‡πâ‡∏°`;
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
            document.getElementById('login-screen').classList.add('hidden'); 
            document.getElementById('link-modal').classList.add('hidden');   
            
            // ‡πÇ‡∏ä‡∏ß‡πå Success Modal
            document.getElementById('success-modal').classList.remove('hidden'); 

            // ‚úÖ FIX: ‡πÉ‡∏™‡πà Try-Catch ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏≠‡∏õ Crash ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Haptic
            try {
                if (tg.hapticFeedback) {
                    tg.hapticFeedback.notificationOccurred('success');
                }
            } catch (e) {
                console.warn("Haptic feedback not supported or failed:", e);
            }
        }

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà Reload)
        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden'); // ‡πÇ‡∏ä‡∏ß‡πå loading ‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á
            refreshUserData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤ Dashboard ‡πÄ‡∏•‡∏¢
        }

        async function submitLogin() {
            const id = document.getElementById('login-cust-id').value.trim();
            const code = document.getElementById('login-verify-code').value.trim();
            if (!id || !code) return tg.showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            
            tg.MainButton.showProgress();
            await performLink(id, code);
            tg.MainButton.hideProgress();
        }

        async function submitLinkAccount() {
            const id = document.getElementById('link-code').value.trim();
            const code = document.getElementById('verify-code').value.trim();
            if (!id || !code) return tg.showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            
            tg.MainButton.showProgress();
            await performLink(id, code);
            tg.MainButton.hideProgress();
        }


        function openLinkModal() {
            hideBottomNav(); // Hide nav bar when modal opens
            const modal = document.getElementById('link-modal');
            const content = document.getElementById('link-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeLinkModal() {
            showBottomNav(); // Show nav bar when modal closes
            const modal = document.getElementById('link-modal');
            const content = document.getElementById('link-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                showToast('üí° ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            }, 300);
        }

        function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ
            const value = Math.floor(progress * (end - start) + start);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÉ‡∏™‡πà comma ‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢)
            obj.innerHTML = value.toLocaleString();
            
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ
                obj.innerHTML = end.toLocaleString();
            }
        };
        window.requestAnimationFrame(step);
        }

        async function openHistoryModal() {
            hideBottomNav(); // Hide nav bar when modal opens
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');
            const list = document.getElementById('history-list');

            // 1. ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏¢‡∏±‡∏ö
            document.body.classList.add('no-scroll');

            modal.classList.remove('hidden');
            
            // Animation ‡πÄ‡∏õ‡∏¥‡∏î
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('translate-y-full');
            }, 10);

            try {
                // Use cached user ID if available (fixes browser testing issues)
                const telegramId = window.currentUser?.telegramUserId || tg.initDataUnsafe?.user?.id;

                if (!telegramId) {
                    throw new Error("User ID not found");
                }
                const res = await fetch(`/api/history/${telegramId}`);
                const data = await res.json();
                
                if (data.logs && data.logs.length > 0) {
                    let html = '<div class="space-y-3">'; // Start with space-y for spacing
                    data.logs.forEach((item, index) => {
                        const colorClass = item.isPositive ? 'text-green-400' : 'text-red-400';
                        const icon = item.isPositive ? 'ri-arrow-up-circle-fill' : 'ri-arrow-down-circle-fill';
                        html += `
                        <div class="bg-white/5 p-3 rounded-xl flex items-center justify-between border border-white/10 group cursor-pointer transition item-hover-effect list-item-animate" style="animation-delay: ${index * 60}ms" onclick="toggleTier2('${item.id}')">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center ${colorClass} text-xl">
                                    <i class="${icon}"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">${item.action}</div>
                                    <div class="text-xs text-gray-500">${item.date}</div>
                                </div>
                            </div>
                            <div class="font-bold ${colorClass}">${item.points}</div>
                        </div>`;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                } else {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-500 opacity-60"><i class="ri-history-line text-6xl mb-4"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>`;
                }
            } catch (e) {
                console.error("Error in openHistoryModal:", e);
                list.innerHTML = '<div class="text-center text-red-400 mt-10">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                // Also show a toast notification for critical errors
                showToast(e.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥", 'error');
            }
        }

        function closeHistoryModal() {
            showBottomNav(); // Show nav bar when modal closes
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');
            
            // 2. ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ
            document.body.classList.remove('no-scroll');

            content.classList.add('translate-y-full');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- [START] Rewards Logic ---
        async function openRewardsModal() {
            hideBottomNav(); // Hide nav bar when modal opens
            const modal = document.getElementById('rewards-modal');
            const content = document.getElementById('rewards-content');
            const list = document.getElementById('rewards-list');

            document.body.classList.add('no-scroll');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('translate-y-full');
            }, 10);

            try {
                const res = await fetch('/api/rewards');
                const rewards = await res.json();

                if (rewards && rewards.length > 0) {
                    let html = '<div class="grid grid-cols-2 gap-3">'; // Start with grid for rewards
                    rewards.forEach(item => {
                        // Add a check for item.points to ensure it exists
                        const pointsDisplay = (item.points !== undefined && item.points !== null) ? `${item.points.toLocaleString()} pts` : 'N/A pts';

                        html += `
                    <div class="bg-white/5 p-3 rounded-xl border border-white/10 flex flex-col items-center text-center group hover:bg-white/10 transition item-hover-effect">
                        <div class="w-16 h-16 rounded-full bg-[#F22233]/20 text-[#F22233] flex items-center justify-center text-3xl mb-3 shadow-[0_0_15px_rgba(168,85,247,0.3)] group-hover:scale-110 transition">
                            <i class="ri-gift-2-fill"></i>
                        </div>
                        <div class="font-bold text-sm text-white mb-1 line-clamp-2 min-h-[2.5em]">${item.name}</div>
                        <div class="text-yellow-400 font-bold text-sm bg-yellow-500/10 px-3 py-1 rounded-full border border-yellow-500/20">
                            ${pointsDisplay}
                        </div>
                    </div>`;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                } else {
                    list.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 opacity-60">
                        <i class="ri-gift-line text-6xl mb-4"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
                    </div>`;
                }
            } catch (e) {
                console.error("Error in openRewardsModal:", e);
                list.innerHTML = '<div class="text-center text-red-400 mt-10">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
                showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•", 'error');
            }
        }

        function closeRewardsModal() {
            showBottomNav(); // Show nav bar when modal closes
            const modal = document.getElementById('rewards-modal');
            const content = document.getElementById('rewards-content');

            document.body.classList.remove('no-scroll');
            content.classList.add('translate-y-full');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        // --- [END] Rewards Logic ---

        async function openInviteModal() {
            console.log("[Invite Modal] Opening...");

            if (!window.currentUser || !window.currentUser.customerId) {
                console.error("[Invite Modal] Failed: currentUser or customerId not found.", window.currentUser);
                try { Telegram.WebApp.hapticFeedback.notificationOccurred('error'); } catch(e) {}
                Telegram.WebApp.showAlert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
                return;
            }
            console.log("[Invite Modal] currentUser is available:", window.currentUser);

            hideBottomNav();
            const modal = document.getElementById('invite-modal');
            const content = document.getElementById('invite-content');
            const linkInput = document.getElementById('invite-link');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const downloadQrBtn = document.getElementById('download-qr-btn');

            const botUsername = getConfig('orderBotUsername', 'YOUR_ORDER_BOT_USERNAME_HERE');
            const userId = window.currentUser?.customerId || "UNKNOWN";
            const inviteLink = `https://t.me/${botUsername}?startapp=app-ref_${userId}`;
            linkInput.value = inviteLink;
            console.log(`[Invite Modal] Generated link: ${inviteLink}`);

            qrCodeContainer.innerHTML = ''; // Clear previous QR code
            
            // --- New API-based QR Code Generation ---
            try {
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(inviteLink)}&size=200x200&bgcolor=050C0D&color=ffffff&qzone=1`;
                console.log(`[Invite Modal] QR API URL: ${qrApiUrl}`);

                const img = document.createElement('img');
                img.src = qrApiUrl;
                img.classList.add('w-full', 'h-full', 'rounded-lg');
                img.onload = () => {
                    console.log("[Invite Modal] QR Code image loaded successfully.");
                };
                img.onerror = () => {
                     console.error("[Invite Modal] Failed to load QR Code image from API.");
                     qrCodeContainer.innerHTML = '<p class="text-red-500 text-xs">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ QR Code ‡πÑ‡∏î‡πâ</p>';
                };
                qrCodeContainer.appendChild(img);

                downloadQrBtn.onclick = async () => {
                    try {
                        const response = await fetch(qrApiUrl);
                        if (!response.ok) throw new Error('Network response was not ok.');
                        const blob = await response.blob();
                        const file = new File([blob], `qr-invite-${userId}.png`, { type: blob.type });

                        // Use Web Share API if available
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                files: [file],
                                title: 'QR Code ‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô',
                                text: '‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°',
                            });
                            showToast('‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                        } else {
                            // Fallback for browsers that don't support sharing files
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `qr-invite-${userId}.png`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                    } catch (err) {
                        console.error('Share/Download failed:', err);
                        // Final fallback: open the image in a new tab
                        window.open(qrApiUrl, '_blank');
                        showToast('‡πÄ‡∏õ‡∏¥‡∏î QR Code ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà', 'info');
                    }
                };
                downloadQrBtn.classList.remove('hidden');

            } catch (error) {
                console.error("[Invite Modal] Error during QR code generation:", error);
                qrCodeContainer.innerHTML = '<p class="text-red-500 text-xs">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</p>';
                downloadQrBtn.classList.add('hidden');
            }


            const universalBtn = document.getElementById('universal-share-btn');
            const fallbackContainer = document.getElementById('fallback-share-container');

            if (navigator.share) {
                universalBtn.classList.remove('hidden');
                fallbackContainer.classList.add('hidden');
            } else {
                universalBtn.classList.add('hidden');
                fallbackContainer.classList.remove('hidden');
            }

            document.body.classList.add('no-scroll');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('translate-y-full');
            }, 10);
             console.log("[Invite Modal] Modal is now visible.");
        }

        function closeInviteModal() {
            showBottomNav(); // Show nav bar when modal closes
            const modal = document.getElementById('invite-modal');
            const content = document.getElementById('invite-content');

            document.body.classList.remove('no-scroll');
            content.classList.add('translate-y-full');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function copyInviteLink() {
            const linkInput = document.getElementById('invite-link');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // Mobile

            navigator.clipboard.writeText(linkInput.value).then(() => {
                showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß!", "success");
            }).catch(() => {
                showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ", "error");
            });
        }
        
        async function universalShare() {
            const linkInput = document.getElementById('invite-link');
            const shareData = {
                title: '‡∏°‡∏≤‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏Å‡∏±‡∏ô!',
                text: '‡∏°‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô‡∏™‡∏¥! ‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢: ',
                url: linkInput.value
            };
            try {
                await navigator.share(shareData);
                showToast('‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch(err) {
                console.error("Share failed:", err);
                showToast('‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
            }
        }

        function shareOnTelegram() {
            const linkInput = document.getElementById('invite-link');
            const referralLink = linkInput.value;
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent('‡∏°‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô‡∏™‡∏¥! ‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢: ')}`;
            window.Telegram.WebApp.openTelegramLink(shareUrl);
        }

        function shareOnLine() {
            const linkInput = document.getElementById('invite-link');
            const text = encodeURIComponent(`‡∏°‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô‡∏™‡∏¥!\n${linkInput.value}`);
            const shareUrl = `https://line.me/R/msg/text/?${text}`;
            window.open(shareUrl, '_blank');
        }

        function shareOnWhatsApp() {
            const linkInput = document.getElementById('invite-link');
            const text = encodeURIComponent(`‡∏°‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô‡∏™‡∏¥! ${linkInput.value}`);
            const shareUrl = `https://api.whatsapp.com/send?text=${text}`;
            window.open(shareUrl, '_blank');
        }
        // --- [END] Invite Logic ---

        // --- [START] Referral Logic ---

        async function openReferralModal() {
            hideBottomNav(); // Hide nav bar when modal opens
            const modal = document.getElementById('referral-modal');
            const content = document.getElementById('referral-content');
            const list = document.getElementById('referral-list');

            // ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Modal
            document.body.classList.add('no-scroll');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('translate-y-full');
            }, 10);

            // Initial loading state
            list.innerHTML = '<div class="text-center text-gray-500 mt-10 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥...</div>';

            try {
                // Use cached user ID if available (fixes browser testing issues)
                const telegramId = window.currentUser?.telegramUserId || tg.initDataUnsafe?.user?.id;

                if (!telegramId) {
                    throw new Error("User ID not found");
                }

                const res = await fetch(`/api/referrals/${telegramId}`);
                const result = await res.json();

                if (result.success && result.data.length > 0) {
                    document.getElementById('ref-total-count').innerText = result.count;
                    const totalEarned = result.data.reduce((sum, item) => sum + item.earned, 0);
                    document.getElementById('ref-total-earned').innerText = totalEarned.toLocaleString();

                    let html = '';
                    result.data.forEach((item, index) => {
                        const hasTier2 = item.tier2Referrals && item.tier2Referrals.length > 0;

                        const campaignBadge = item.campaign.includes('Standard')
                            ? `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-gray-700/50 text-gray-400 text-[9px] border border-gray-600/30"><i class="ri-flag-line"></i> ${item.campaign}</span>`
                            : `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-300 text-[9px] border border-purple-500/30"><i class="ri-flashlight-fill"></i> ${item.campaign}</span>`;

                        html += `
                        <div class="bg-white/5 p-3 rounded-xl border border-white/10 space-y-2 transition item-hover-effect list-item-animate ${hasTier2 ? 'cursor-pointer' : ''}" style="animation-delay: ${index * 60}ms" ${hasTier2 ? `onclick="toggleTier2('${item.id}')"` : ''}>
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2">
                                    <i id="ref-icon-${item.id}" class="ri-arrow-right-s-line text-gray-500 transition-transform ${hasTier2 ? '' : 'invisible'}"></i>
                                    <span class="font-mono font-bold text-[#F22233] text-sm">${item.id}</span>
                                </div>
                                <span class="font-bold text-lg text-yellow-400 flex items-center gap-1.5">
                                    <i class="ri-copper-coin-line"></i> +${item.earned}
                                </span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-gray-400 pt-1 border-t border-white/5">
                                ${campaignBadge}
                                <span class="flex items-center gap-1.5">
                                    <i class="ri-calendar-check-line"></i>
                                    <span>${item.joinedAt}</span>
                                </span>
                            </div>`;
                        
                        if (hasTier2) {
                            html += `<div id="tier2-list-${item.id}" class="tier2-list pt-2 mt-2 border-t border-white/20 space-y-1 pl-5">`;
                            item.tier2Referrals.forEach(t2 => {
                                html += `
                                <div class="flex justify-between items-center text-xs">
                                    <span class="font-mono text-gray-400">${t2.id}</span>
                                    <span class="text-gray-500">${t2.joinDate}</span>
                                </div>`;
                            });
                            html += `</div>`;
                        }

                        html += `</div>`;
                    });
                    list.innerHTML = html;
                } else {
                    document.getElementById('ref-total-count').innerText = "0";
                    document.getElementById('ref-total-earned').innerText = "0";
                    list.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 opacity-60">
                        <i class="ri-team-line text-6xl mb-4"></i>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
                        <button onclick="handleAction('invite')" class="mt-4 px-4 py-2 bg-[#F22233] rounded-lg text-white text-sm">
                            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢!
                        </button>
                    </div>`;
                }
                } catch (e) {
                    console.error("Error in openReferralModal:", e);
                    list.innerHTML = '<div class="text-center text-red-400 mt-10">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î (v3)</div>';
                }        }

        function closeReferralModal() {
            showBottomNav(); // Show nav bar when modal closes
            const modal = document.getElementById('referral-modal');
            const content = document.getElementById('referral-content');
            
            document.body.classList.remove('no-scroll');
            content.classList.add('translate-y-full');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function toggleTier2(itemId) {
            const tier2List = document.getElementById(`tier2-list-${itemId}`);
            const icon = document.getElementById(`ref-icon-${itemId}`);
            if (tier2List && icon) {
                // Animate the list expand/collapse
                if (tier2List.style.maxHeight && tier2List.style.maxHeight !== "0px") {
                    tier2List.style.maxHeight = "0px";
                    tier2List.style.opacity = 0;
                } else {
                    tier2List.style.maxHeight = tier2List.scrollHeight + "px";
                    tier2List.style.opacity = 1;
                }
                
                // Rotate the icon
                icon.classList.toggle('rotate-90');
            }
        }

        // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        document.getElementById('referral-modal').addEventListener('click', function(e) {
            if (e.target === this) closeReferralModal();
        });
        document.getElementById('campaign-modal').addEventListener('click', function(e) {
            if (e.target === this) closeCampaignModal();
        });
        document.getElementById('rewards-modal').addEventListener('click', function(e) {
            if (e.target === this) closeRewardsModal();
        });
        document.getElementById('invite-modal').addEventListener('click', function(e) {
            if (e.target === this) closeInviteModal();
        });

        // --- Campaign Detail Modal Logic ---
        function openCampaignModal() {
            hideBottomNav(); // Hide nav bar when modal opens
            const user = window.currentUser;
            if (!user) return;

            const modal = document.getElementById('campaign-modal');
            const content = document.getElementById('campaign-content');

            // Populate Data
            const campaignName = user.activeCampaignTag || 'Special Campaign';
            const basePoints = user.referralBasePoints || 50;
            const target = user.referralTarget || 5;
            const bonus = user.milestoneBonus || 0;

            document.getElementById('modal-camp-name').innerText = campaignName;
            document.getElementById('modal-camp-base').innerText = basePoints;
            document.getElementById('modal-camp-target-title').innerText = `‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö ${target} ‡∏Ñ‡∏ô`;
            document.getElementById('modal-camp-bonus-desc').innerText = `‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ${bonus} ‡πÅ‡∏ï‡πâ‡∏°`;

            if (user.campaignStartAt && user.campaignEndAt) {
                 const dStart = new Date(user.campaignStartAt);
                 const dEnd = new Date(user.campaignEndAt);
                 const fmt = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                 document.getElementById('mission-dates').innerText = `${dStart.toLocaleDateString('th-TH', fmt)} - ${dEnd.toLocaleDateString('th-TH', fmt)}`;
            } else {
                 document.getElementById('mission-dates').innerText = '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≥‡∏Å‡∏±‡∏î';
            }

            // Show
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeCampaignModal() {
            showBottomNav(); // Show nav bar when modal closes
            const modal = document.getElementById('campaign-modal');
            const content = document.getElementById('campaign-content');

            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- [END] Referral Logic ---

        // --- [START] ‡∏£‡∏∞‡∏ö‡∏ö Real-time (Auto Polling) ---

        let isFirstLoad = true; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å

        // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ä‡∏≠‡∏ö)
        setInterval(async () => {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ User ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏° (‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏ö‡∏à‡∏≠‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏ô‡πá‡∏ï)
            if (document.hidden) return;

            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡πà‡∏á true ‡πÑ‡∏õ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£ Auto Refresh ‡∏ô‡∏∞)
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ô refreshUserData ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå Loading Screen
                await refreshUserData(true); 
                
            } catch (e) {
                console.log("Auto sync failed (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î):", e);
            }
        }, 5000); // 5000 ms = 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

        // --- [END] ‡∏£‡∏∞‡∏ö‡∏ö Real-time ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å" ‡πÉ‡∏ô Bottom Nav
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            try { tg.hapticFeedback.impactOccurred('light'); } catch(e){}
        }

        // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß Modal ‡πÉ‡∏´‡∏ç‡πà
        document.getElementById('history-modal').addEventListener('click', function(e) {
            // e.target ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡πâ‡∏ß‡πÑ‡∏õ‡∏à‡∏¥‡πâ‡∏°
            // this ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß history-modal (‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á)
            
            // ‡∏ñ‡πâ‡∏≤‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏¥‡πâ‡∏° ‡∏Ñ‡∏∑‡∏≠‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏¥‡πâ‡∏°‡πÇ‡∏î‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô)
            if (e.target === this) {
                closeHistoryModal(); // ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
        });

        // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏¥‡πâ‡∏°‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á ---
        document.getElementById('history-modal').addEventListener('click', function(e) {
            // e.target ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡πâ‡∏ß‡πÑ‡∏õ‡πÇ‡∏î‡∏ô
            // this ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß history-modal (‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏î‡∏≥)
            
            // ‡∏ñ‡πâ‡∏≤‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏ô == ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á (‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏¥‡πâ‡∏°‡πÇ‡∏î‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≤‡∏ß‡πÜ)
            if (e.target === this) {
                closeHistoryModal(); // ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢ V2
            }
        });

        // Function to hide bottom nav bar
        function hideBottomNav() {
            const nav = document.getElementById('bottom-nav');
            if (nav) nav.classList.add('hide');
        }

        // Function to show bottom nav bar
        function showBottomNav() {
            const nav = document.getElementById('bottom-nav');
            if (nav) nav.classList.remove('hide');
        }

        initApp();
    </script>

    <!-- Bottom Navigation Bar -->
    <div id="bottom-nav" class="fixed bottom-4 left-0 right-0 z-[70] mx-auto w-[calc(100%-2.5rem)] max-w-md bg-[var(--secondary-bg)] shadow-xl rounded-full p-2 flex justify-around items-center">
        <a href="home.html" class="flex flex-col items-center text-xs font-medium text-gray-400 w-1/3 py-1.5 rounded-xl transition active:scale-95">
            <i class="ri-home-4-line text-xl"></i>
            <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </a>
        <a href="https://bit.ly/onehub-catalogue" target="_blank" class="flex flex-col items-center text-xs font-medium text-gray-400 w-1/3 py-1.5 rounded-xl transition active:scale-95">
            <i class="ri-shopping-cart-line text-xl"></i>
            <span>‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
        </a>
        <a href="dashboard.html" class="flex flex-col items-center text-xs font-medium text-[#F22233] w-1/3 py-1.5 rounded-xl transition active:scale-95">
            <i class="ri-wallet-3-line text-xl"></i>
            <span>‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        </a>
    </div>
</body>
</html>
