<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loyalty App</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050C0D;
            --text-color: #ffffff;
            --secondary-bg: #161B22;
            --hint-color: #ffffff;
            --button-color: #F22233;
            --button-text: #ffffff;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Kanit', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        .input-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4b5563;
            transition: all 0.3s;
        }
        .input-box:focus {
            border-color: #3b82f6;
            outline: none;
            background: rgba(0, 0, 0, 0.5);
        }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shimmer { 0% { transform: translateX(-100%) skewX(-12deg); } 100% { transform: translateX(100%) skewX(-12deg); } }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); color: white; padding: 14px 16px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; opacity: 0; transform: translateY(-20px) scale(0.95); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateY(0) scale(1); }
        .toast-icon { font-size: 20px; }
        .toast.success .toast-icon { color: #4ade80; text-shadow: 0 0 10px rgba(74,222,128,0.5); }
        .toast.error .toast-icon { color: #f87171; text-shadow: 0 0 10px rgba(248,113,113,0.5); }
        .toast.warning .toast-icon { color: #facc15; text-shadow: 0 0 10px rgba(250,204,21,0.5); }
        .toast.info .toast-icon { color: #60a5fa; text-shadow: 0 0 10px rgba(96,165,250,0.5); }
        .header-actions { position: absolute; top: 20px; right: 20px; z-index: 100; }
        .refresh-btn { background: rgba(2, 2, 2, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; width: 40px; height: 40px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .refresh-btn:active { transform: scale(0.9) rotate(180deg); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        body.no-scroll { overflow: hidden !important; position: fixed; width: 100%; }
        #history-modal .overflow-y-auto, #rewards-modal .overflow-y-auto, #referral-modal .overflow-y-auto { overscroll-behavior: contain; }
        .list-item-animate { animation: slideIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .tier2-list { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .item-hover-effect:hover { border-color: rgba(96, 165, 250, 0.5); box-shadow: 0 0 15px rgba(96, 165, 250, 0.1); }
        #bottom-nav { transition: transform 0.3s ease-in-out; }
        #bottom-nav.hide { transform: translateY(150%); }
        #qr-code-container { display: flex; justify-content: center; align-items: center; margin-top: 20px; margin-bottom: 20px; background: transparent; padding: 10px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 0 20px rgba(255, 255, 255, 0.05); }
        #qr-code-container img { border-radius: 12px; }
        .download-qr-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 12px 20px; color: white; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .download-qr-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .download-qr-btn:active { transform: scale(0.98); }
    </style>
</head>
<body class="min-h-screen flex flex-col p-5 select-none overflow-x-hidden">

    <div class="header-actions hidden">
        <button class="refresh-btn" onclick="manualRefresh(); try { Telegram.WebApp.hapticFeedback.impactOccurred('medium'); } catch(e){}">
            <i class="ri-refresh-line text-xl"></i>
        </button>
    </div>

    <div id="toast-container"></div>

    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#050C0D]">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-400 animate-pulse" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <div id="login-screen" class="hidden fixed inset-0 z-40 bg-[#050C0D] flex flex-col items-center justify-center p-6">
        <div class="glass-card p-8 w-full max-w-sm text-center shadow-2xl relative overflow-hidden fade-in">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-[#F22233]/20 rounded-full blur-3xl"></div>
            <div class="w-20 h-20 bg-gradient-to-tr from-[#F2A71B] to-[#F28627] text-white rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-lg relative z-10">üîó</div>
            <h2 class="text-2xl font-bold mb-2 text-white relative z-10">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h2>
            <p class="text-gray-400 text-sm mb-8 relative z-10">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            <div class="space-y-4 text-left relative z-10">
                <div>
                    <label class="text-xs text-gray-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                    <input type="text" id="login-cust-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô OT99999" class="w-full input-box rounded-xl p-4 text-white text-center tracking-wider uppercase text-lg placeholder-gray-600">
                </div>
                <div>
                    <label class="text-xs text-gray-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å</label>
                    <input type="tel" id="login-verify-code" maxlength="4" placeholder="XXXX" class="w-full input-box rounded-xl p-4 text-white text-center tracking-[0.5em] text-xl placeholder-gray-600">
                </div>
            </div>
            <button onclick="submitLogin()" class="w-full mt-8 py-4 bg-gradient-to-r from-[#F22233] to-[#F24E29] hover:from-blue-500 hover:to-blue-400 rounded-xl font-bold text-lg text-white shadow-lg shadow-[#F22233]/30 transition active:scale-95 relative z-10">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p class="text-[10px] text-gray-600 mt-6 relative z-10">*‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
        </div>
    </div>
    
    <div id="welcome-screen" class="hidden w-full max-w-md mx-auto space-y-6 pb-32 text-center">
        <img src="logo.png" alt="Company Logo" class="w-64 mx-auto mb-8">
        <h1 class="text-3xl font-bold mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h1>
        <p class="text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
    </div>

    <div id="app-content" class="hidden w-full max-w-md mx-auto space-y-6 pb-32 fade-in">
        <div class="flex justify-center mb-4">
            <img src="logo.png" alt="Company Logo" class="w-48">
        </div>
        <div class="flex items-center space-x-4">
            <div class="relative">
                <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-[#F2A71B] to-[#F28627] flex items-center justify-center text-4xl shadow-lg shadow-blue-500/20">üë§</div>
                <div class="absolute -bottom-1 -right-1 bg-green-500 w-4 h-4 rounded-full border-2 border-[#18181b]"></div>
            </div>
            <div>
                <h2 id="user-name" class="text-xl font-bold leading-tight">...</h2>
                <p class="text-xs text-gray-400">ID: <span id="user-id">...</span></p>
            </div>
        </div>
        <div class="glass-card p-6 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="ri-vip-diamond-line text-9xl"></i></div>
            <p class="text-sm text-gray-300 mb-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div class="flex items-baseline space-x-2">
                <h1 id="user-points" class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#F2A71B] to-[#F28627]">0</h1>
                <span class="text-sm text-yellow-500 font-medium">Points</span>
            </div>
            <div class="mt-4 flex justify-between items-end">
                <div class="text-xs text-gray-400">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span id="expiry-date" class="text-white">...</span></div>
                <button onclick="openHistoryModal(); try { Telegram.WebApp.hapticFeedback.impactOccurred('medium'); } catch(e){}" class="bg-white/5 hover:bg-white/10 p-4 rounded-2xl flex flex-col items-center justify-center gap-2 transition group">
                    <div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-xl group-hover:scale-110 transition"><i class="ri-history-line"></i></div>
                    <span class="text-xs font-medium text-gray-300">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
                </button>
            </div>
        </div>
        <div id="mission-box" onclick="openCampaignModal()" class="glass-card p-5 hidden relative overflow-hidden border border-yellow-500/50 shadow-[0_0_15px_rgba(234,179,8,0.15)] group transition active:scale-95 cursor-pointer">
            <div class="absolute -top-10 -right-10 w-20 h-20 bg-yellow-500/20 rounded-full blur-2xl animate-pulse"></div>
            <div class="flex justify-between items-start mb-3 relative z-10">
                <div>
                    <div class="font-bold text-sm text-yellow-400 flex items-center gap-2"><i class="ri-flashlight-fill animate-pulse"></i> <span id="mission-name">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©</span></div>
                    <div class="text-[10px] text-yellow-200/70 mt-0.5" id="mission-dates">...</div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="mission-base-badge" class="text-[10px] bg-slate-600/30 text-slate-200 border border-slate-400/30 px-2 py-1 rounded-lg backdrop-blur-sm shadow-sm">‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô +50</span>
                    <span id="mission-bonus-badge" class="relative text-[10px] bg-gradient-to-br from-yellow-500/30 to-yellow-600/10 text-yellow-200 border border-yellow-400/50 px-2 py-1 rounded-lg shadow-[0_0_15px_rgba(234,179,8,0.4)] overflow-hidden">
                        <span class="relative z-10">‡πÇ‡∏ö‡∏ô‡∏±‡∏™ +50</span>
                        <div class="absolute inset-0 bg-white/40 w-full h-full -skew-x-12 translate-x-[-150%] animate-[shimmer_3s_infinite]"></div>
                    </span>
                </div>
            </div>
            <div class="relative z-10 pt-2">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex flex-col"><span class="text-[10px] text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ</span><span id="mission-current" class="text-3xl font-bold text-white leading-none">0</span></div>
                    <div class="h-8 w-[1px] bg-white/10"></div>
                    <div class="flex flex-col items-end"><span class="text-[10px] text-gray-400">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span><span id="mission-target" class="text-3xl font-bold text-yellow-400 leading-none">5</span></div>
                </div>
                <div class="bg-white/5 rounded-lg p-2 flex items-center justify-between border border-white/5">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center text-xs"><i class="ri-gift-fill"></i></div>
                        <span id="mission-desc" class="text-[10px] text-gray-300">‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏Ñ‡∏ô ‡∏£‡∏±‡∏ö‡πÇ‡∏ö‡∏ô‡∏±‡∏™</span>
                    </div>
                    <span id="mission-status-text" class="text-[9px] text-yellow-500/80 font-mono">ON GOING</span>
                </div>
            </div>
        </div>
        <div class="glass-card p-5 group cursor-pointer transition active:scale-95" onclick="openReferralModal(); try { Telegram.WebApp.hapticFeedback.impactOccurred('medium'); } catch(e){}">
            <div class="mb-4 font-semibold text-sm flex items-center gap-2 text-blue-100"><i class="ri-team-fill text-[#F22233]"></i> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
            <div class="grid grid-cols-2 gap-4 relative">
                <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[1px] h-8 bg-white/10"></div>
                <div class="text-center group">
                    <div class="text-[10px] text-gray-400 mb-1 group-hover:text-blue-300 transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div class="text-2xl font-bold text-white tracking-wide" id="referral-total-all">0</div>
                </div>
                <div class="text-center group">
                    <div class="text-[10px] text-gray-400 mb-1 group-hover:text-green-300 transition">‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                    <div class="text-2xl font-bold text-green-400 tracking-wide" id="referral-total-month">0</div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="openRewardsModal()" class="glass-card p-4 hover:bg-white/10 transition active:scale-95 text-left group">
                <div class="w-10 h-10 rounded-full bg-[#F22233]/20 flex items-center justify-center text-[#F22233] mb-3 group-hover:scale-110 transition"><i class="ri-gift-2-line text-xl"></i></div>
                <div class="font-semibold">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
                <div class="text-xs text-gray-400">‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
            </button>
            <button onclick="openInviteModal()" class="glass-card p-4 hover:bg-white/10 transition active:scale-95 text-left group">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 mb-3 group-hover:scale-110 transition"><i class="ri-user-add-line text-xl"></i></div>
                <div class="font-semibold">‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</div>
                <div class="text-xs text-gray-400">‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©</div>
            </button>
        </div>
    </div>
    <div id="link-modal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 hidden opacity-0 transition-opacity duration-300">
        <!-- link-modal content -->
    </div>
    <div id="invite-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <!-- invite-modal content -->
    </div>
    <div id="rewards-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <!-- rewards-modal content -->
    </div>
    <div id="success-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-sm p-6">
        <!-- success-modal content -->
    </div>
    <div id="history-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <!-- history-modal content -->
    </div>
    <div id="campaign-modal" class="hidden fixed inset-0 z-[65] flex items-center justify-center bg-black/90 backdrop-blur-md opacity-0 transition-opacity duration-300 p-6">
        <!-- campaign-modal content -->
    </div>
    <div id="referral-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/90 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <!-- referral-modal content -->
    </div>
    
    <div id="bottom-nav" class="fixed bottom-4 left-0 right-0 z-[70] mx-auto w-[calc(100%-2.5rem)] max-w-md bg-[var(--secondary-bg)] shadow-xl rounded-full p-2 flex justify-around items-center">
        <a href="javascript:void(0)" onclick="showWelcomeScreen()" class="nav-btn flex flex-col items-center text-xs font-medium text-gray-400 w-1/3 py-1.5 rounded-xl transition active:scale-95">
            <i class="ri-home-4-line text-xl"></i>
            <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </a>
        <a href="https://bit.ly/onehub-catalogue" target="_blank" class="flex flex-col items-center text-xs font-medium text-gray-400 w-1/3 py-1.5 rounded-xl transition active:scale-95">
            <i class="ri-shopping-cart-line text-xl"></i>
            <span>‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
        </a>
        <a href="javascript:void(0)" onclick="showDashboardScreen()" class="nav-btn flex flex-col items-center text-xs font-medium text-gray-400 w-1/3 py-1.5 rounded-xl transition active:scale-95">
            <i class="ri-wallet-3-line text-xl"></i>
            <span>‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        </a>
    </div>

    <script>
    const tg = window.Telegram.WebApp;

    // --- Page View Management ---
    function showWelcomeScreen() {
        document.getElementById('welcome-screen').classList.remove('hidden');
        document.getElementById('app-content').classList.add('hidden');
        document.querySelector('.header-actions').classList.add('hidden');
        updateNav('welcome');
    }

    function showDashboardScreen() {
        document.getElementById('welcome-screen').classList.add('hidden');
        document.getElementById('app-content').classList.remove('hidden');
        document.querySelector('.header-actions').classList.remove('hidden');
        updateNav('dashboard');
    }
    
    function updateNav(activeView) {
        const navButtons = document.querySelectorAll('.nav-btn');
        navButtons.forEach(btn => {
            btn.classList.remove('text-[#F22233]');
            btn.classList.add('text-gray-400');
        });
        if (activeView === 'welcome') {
            document.querySelector('a[onclick="showWelcomeScreen()"]').classList.add('text-[#F22233]');
        } else if (activeView === 'dashboard') {
            document.querySelector('a[onclick="showDashboardScreen()"]').classList.add('text-[#F22233]');
        }
    }


    // --- Main App Logic (from dashboard.html) ---
    window.appConfig = { orderBotUsername: '' };
    window.currentUser = null;
    function getConfig(key, defaultValue = '') { return window.appConfig[key] || defaultValue; }
    
    // ... [ All other functions from dashboard.html's script tag: showToast, manualRefresh, etc. ] ...
    // NOTE: The full script content from dashboard.html needs to be pasted here.
    // This is a placeholder for brevity.

    async function initApp() {
        try {
            const startParam = tg.initDataUnsafe?.start_param;
            console.log(`[Init] start_param received: ${startParam}`);
            
            if (startParam) {
                // If there's a start param, always go to the dashboard to handle it
                await refreshUserData(); 
                if (startParam.startsWith('ref_')) {
                    const referrerId = startParam.split('_')[1];
                    await handleReferralFlow(referrerId);
                } else if (startParam.startsWith('link_')) {
                    const parts = startParam.split('_');
                    if (parts.length === 3) await performLink(parts[1], parts[2]);
                }
            } else {
                // Normal entry
                await refreshUserData();
            }
        } catch (error) {
            console.error("Critical Error in initApp:", error);
            showToast(error.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", 'error');
            showLoginScreen();
        }
    }

    function renderUser(user) {
        // This function now shows the dashboard and hides other screens
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        showDashboardScreen(); // Show the main app content

        //... (rest of the renderUser logic from dashboard.html)
        document.getElementById('user-name').innerText = `${user.firstName} ${user.lastName || ''}`.trim();
        document.getElementById('user-id').innerText = user.customerId || 'N/A';
        // ... etc.
    }

    function showLoginScreen() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('welcome-screen').classList.add('hidden');
        document.getElementById('app-content').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        document.querySelector('.header-actions').classList.add('hidden');
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        tg.ready();
        tg.expand();
        if (tg.isVersionAtLeast('7.7')) tg.disableVerticalSwipes();
        tg.enableClosingConfirmation();
        initApp();
    });

    // --- And all the other helper functions from dashboard.html ---
    
    </script>
</body>
</html>